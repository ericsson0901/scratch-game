<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>åˆ®åˆ®æ¨‚éŠæˆ²</title>
  <style>
    body { font-family: Arial, sans-serif; text-align:center; margin:0; padding:0; }
    .grid { display: grid; gap: 8px; margin:20px auto; justify-content:center; }
    .cell {
      display:flex; align-items:center; justify-content:center;
      cursor:pointer; border-radius:8px; background: white;
      position: relative; overflow: hidden;
      font-size: 24px; font-weight:bold;
    }
    .cell::before {
      content: "";
      position: absolute;
      inset: 0;
      background: silver;
      transition: transform 0.8s ease-out;
      transform: translateX(0);
    }
    .cell.revealing::before {
      transform: translateX(100%);
    }
    .scratched { border: 2px solid #333; background: white; }

    /* æ‰‹æ©Ÿç‰ˆè‡ªé©æ‡‰ */
    @media (max-width: 600px) {
      .cell { width: 50px !important; height: 50px !important; font-size: 18px !important; }
      .grid { gap: 6px; }
    }
    @media (max-width: 400px) {
      .cell { width: 40px !important; height: 40px !important; font-size: 16px !important; }
      .grid { gap: 4px; }
    }
  </style>
</head>
<body>
  <h1>ğŸ‰ ç·šä¸Šåˆ®åˆ®æ¨‚ ğŸ‰</h1>

  <div id="game">
    <h2>ä¸­çè™Ÿç¢¼ï¼š<span id="winning"></span></h2>
    <p>å·²åˆ®å‡ºï¼š<span id="scratchedCount">0</span>ã€€å‰©ä¸‹ï¼š<span id="remainingCount">0</span></p>
    <div class="grid" id="grid"></div>
  </div>

<script>
let winningNumber = null;
let totalCells = 0;

async function loadGame() {
  const state = await fetch('/api/game/state').then(r=>r.json());
  winningNumber = state.winningNumber;
  totalCells = state.gridSize;
  document.getElementById('winning').innerText = winningNumber;

  const grid = document.getElementById('grid');
  grid.innerHTML='';

  // æ’åˆ—æ–¹å¼
  const root = Math.sqrt(state.gridSize);
  if (Number.isInteger(root)) {
    grid.style.gridTemplateColumns = `repeat(${root}, auto)`;
  } else {
    grid.style.gridTemplateColumns = `repeat(6, auto)`;
  }

  // æ ¼å­å¤§å°
  let cellSize = 100;
  if (state.gridSize <= 9) cellSize = 100;
  else if (state.gridSize <= 16) cellSize = 90;
  else if (state.gridSize <= 25) cellSize = 80;
  else if (state.gridSize <= 36) cellSize = 70;
  else cellSize = 60;

  for(let i=0;i<state.gridSize;i++){
    const cell=document.createElement('div');
    cell.className='cell';
    cell.style.width = cellSize + 'px';
    cell.style.height = cellSize + 'px';

    if(state.scratched.includes(i)){
      reveal(i, cell);
    }
    cell.onclick=()=>scratch(i, cell);
    grid.appendChild(cell);
  }

  // æ›´æ–°çµ±è¨ˆ
  updateStats(state.scratched.length);
}

async function scratch(i, cell){
  cell.classList.add('revealing');
  if (navigator.vibrate) navigator.vibrate(100);

  setTimeout(async ()=>{
    const res = await fetch('/api/game/scratch',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({index:i})
    });
    const data = await res.json();
    cell.innerText=data.number;

    // æ›´æ–°çµ±è¨ˆ
    const scratchedCount = document.querySelectorAll('.cell.revealing').length;
    updateStats(scratchedCount);

    if(data.number == winningNumber){
      alert('ğŸ‰ æ­å–œä¸­çï¼ä½ åˆ®åˆ°äº†è™Ÿç¢¼ ' + winningNumber);
    }
  }, 800);
}

async function reveal(i, cell){
  const res = await fetch('/api/game/scratch',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({index:i})
  });
  const data = await res.json();
  cell.innerText=data.number;
  cell.classList.add('revealing');
}

// æ›´æ–°çµ±è¨ˆæ•¸å­—
function updateStats(scratchedCount){
  document.getElementById('scratchedCount').innerText = scratchedCount;
  document.getElementById('remainingCount').innerText = totalCells - scratchedCount;
}

window.onload = loadGame;
</script>
</body>
</html>