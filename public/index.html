<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>åˆ®åˆ®æ¨‚éŠæˆ²</title>
  <!-- ä¿æŒæ‰‹æ©Ÿç•«é¢å›ºå®šåœ¨ 100% å¤§å° -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <link rel="stylesheet" href="style.css">
  <style>
    /* å»£å‘Šé®ç½©æ¨£å¼ */
    #adOverlay {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.85);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      color: #fff;
      text-align: center;
    }
    #adOverlay img {
      max-width: 80%;
      border-radius: 10px;
      margin-bottom: 20px;
      box-shadow: 0 0 20px rgba(255,255,255,0.5);
    }
    #closeAdBtn {
      padding: 10px 20px;
      font-size: 18px;
      background: #4caf50;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      color: #fff;
    }
    .grid {
      display: grid;
      gap: 5px;
      margin-top: 20px;
    }
    .cell {
      width: 60px;
      height: 60px;
      background: #ccc;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 20px;
      cursor: pointer;
      border-radius: 5px;
      position: relative;
      overflow: hidden;
      transition: all 0.3s ease;
    }
    /* æ”¾å¤§åˆ°æ­£ä¸­é–“ï¼Œä½”æ»¿è¢å¹• */
    .cell.enlarged {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 80vw;
      height: 80vw;
      background: #fff;
      z-index: 1000;
    }
    /* åˆ®å®Œä¿æŒç™½åº• */
    .cell.revealed {
      background: #fff;
    }
    .scratchCanvas {
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      touch-action: none; /* é˜»æ­¢ iPhone Safari å°‡è§¸æ§è§£è®€æˆæ²å‹• */
    }
    .hiddenNumber {
      position: absolute;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      font-size: 20px;
      color: #000;
      pointer-events: none;
      transition: font-size 0.2s ease;
    }
    /* æ”¾å¤§æ™‚å­—é«”æŒ‰æ¯”ä¾‹æ”¾å¤§ */
    .cell.enlarged .hiddenNumber {
      font-size: 20vw;
    }
    /* ä¸­çè€Œä¸”å·²ç¶“åˆ®å®Œç¸®å°å¾Œæ‰è®Šé‡‘è‰² */
    .cell.win.revealed .hiddenNumber {
      color: gold;
      font-weight: bold;
    }
    /* éŠæˆ²ä»£ç¢¼æ¸…å–®æ¨£å¼ */
    #gameListUl {
      list-style: none;
      padding: 0;
    }
    #gameListUl li {
      margin: 10px 0;
    }
    #gameListUl button {
      padding: 8px 16px;
      font-size: 16px;
      background: #4caf50;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      color: #fff;
    }
    #gameListUl button:hover {
      background: #45a049;
    }

    body.noscroll {
      overflow: hidden;
      width: 100%;
    }

    /* é€æ˜ä½”ä½æ ¼å­æ¨£å¼ */
    .cell.placeholder {
      background: transparent !important;
      border: none !important;
      visibility: hidden;
    }
  </style>
</head>
<body>
  <!-- å»£å‘Šé®ç½© -->
  <div id="adOverlay">
    <img src="https://copilot.microsoft.com/th/id/BCO.43bb37ac-c81c-4745-bd9c-b3572581f76e.png" alt="ç³»çµ±å®¶å…·è¨­è¨ˆå»£å‘Š">
    <button id="closeAdBtn">è¯çµ¡æˆ‘å€‘</button>
  </div>

  <!-- ç™»å…¥å€å¡Š -->
  <div id="login" style="display:none;">
    <h2>è«‹è¼¸å…¥é›»è©±è™Ÿç¢¼</h2>
    <input type="password" id="password" placeholder="è¼¸å…¥é›»è©±è™Ÿç¢¼">
    <button id="loginBtn">é€å‡º</button>
  </div>

  <!-- é¸æ“‡éŠæˆ²ä»£ç¢¼å€å¡Š -->
  <div id="selectGame" style="display:none;">
    <h2>é¸æ“‡éŠæˆ²ä»£ç¢¼</h2>
    <button id="refreshGameListBtn">æ›´æ–°æ¸…å–®</button>
    <ul id="gameListUl"></ul>
  </div>

  <!-- éŠæˆ²å€å¡Š -->
  <div id="game" style="display:none;">
    <h2>ä¸­çè™Ÿç¢¼ï¼š<span id="winning"></span></h2>
    <p>å·²åˆ®å‡ºï¼š<span id="scratchedCount">0</span>ã€€å‰©ä¸‹ï¼š<span id="remainingCount">0</span></p>
    <div class="grid" id="grid"></div>
  </div>

  <script src="game.js"></script>
  <script>
    // === å›ºå®šç©å®¶ UID ===
    if (!localStorage.getItem('playerId')) {
      localStorage.setItem('playerId', crypto.randomUUID());
    }
    const playerId = localStorage.getItem('playerId');

    // å…¨åŸŸç¦æ­¢æ²å‹•æ§åˆ¶
    function disablePageScroll() {
      document.body.classList.add('noscroll');
      window._preventScroll = (e) => { if (e.cancelable) e.preventDefault(); };
      window.addEventListener('touchmove', window._preventScroll, { passive: false });
    }
    function enablePageScroll() {
      document.body.classList.remove('noscroll');
      if (window._preventScroll) {
        window.removeEventListener('touchmove', window._preventScroll);
        window._preventScroll = null;
      }
    }

    // é»æ“Šå»£å‘Šå¾Œé¡¯ç¤ºç™»å…¥å€å¡Š
    document.getElementById('closeAdBtn').addEventListener('click', () => {
      document.getElementById('adOverlay').style.display = 'none';
      document.getElementById('login').style.display = 'block';
    });

    // ç™»å…¥é©—è­‰å…¨åŸŸå¯†ç¢¼
    document.getElementById('loginBtn').addEventListener('click', async () => {
      const password = document.getElementById('password').value;
      const res = await fetch('/api/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ password })
      });
      if (res.ok) {
        document.getElementById('login').style.display = 'none';
        document.getElementById('selectGame').style.display = 'block';
        loadGameList();
      } else {
        const err = await res.json();
        alert(err.error || 'å¯†ç¢¼éŒ¯èª¤');
      }
    });

    // è¼‰å…¥éŠæˆ²ä»£ç¢¼æ¸…å–®
    async function loadGameList() {
      const res = await fetch('/api/game-list');
      if (res.ok) {
        const data = await res.json();
        const ul = document.getElementById('gameListUl');
        ul.innerHTML = '';
        data.codes.forEach(code => {
          const li = document.createElement('li');
          const btn = document.createElement('button');
          btn.textContent = code;
          btn.onclick = () => startSelectedGame(code);
          li.appendChild(btn);
          ul.appendChild(li);
        });
      } else {
        alert('ç„¡æ³•å–å¾—éŠæˆ²æ¸…å–®');
      }
    }

    document.getElementById('refreshGameListBtn').addEventListener('click', loadGameList);

    // å•Ÿå‹•å¿ƒè·³
    function startHeartbeat(gameCode, playerId) {
      setInterval(() => {
        fetch('/api/heartbeat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ code: gameCode, playerId })
        }).catch(err => console.error("å¿ƒè·³å¤±æ•—", err));
      }, 60000); // æ¯ 2 åˆ†é˜é€ä¸€æ¬¡
    }

    // ç©å®¶é€²å…¥éŠæˆ²ä»£ç¢¼
    function startSelectedGame(gameCode) {
      fetch('/api/join-game', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ code: gameCode, playerId })
      }).then(res => {
        if (res.ok) {
          document.getElementById('selectGame').style.display = 'none';
          document.getElementById('game').style.display = 'block';
          if (typeof startGame === 'function') {
            startGame(gameCode);
          }
          startHeartbeat(gameCode, playerId);
        } else {
          res.json().then(err => {
            alert(err.error || "ç„¡æ³•é€²å…¥éŠæˆ²");
          });
        }
      });
    }

    function showWinningNumbers(numbers) {
      document.getElementById('winning').textContent = numbers.join(', ');
    }
    // åˆ®åˆ®æ¨‚æ•ˆæœåˆå§‹åŒ–
    function initScratchCanvas(cell, number) {
      const canvas = document.createElement('canvas');
      canvas.className = 'scratchCanvas';
      canvas.width = cell.offsetWidth;
      canvas.height = cell.offsetHeight;
      const ctx = canvas.getContext('2d');
      ctx.fillStyle = '#C0C0C0';
      ctx.fillRect(0, 0, canvas.width, canvas.height);

      const span = document.createElement('span');
      span.className = 'hiddenNumber';
      span.textContent = number;

      cell.appendChild(span);
      cell.appendChild(canvas);

      function scratch(e) {
        if (e.cancelable) e.preventDefault(); // é˜»æ­¢ iOS é è¨­æ²å‹•
        const rect = canvas.getBoundingClientRect();
        const x = (e.touches ? e.touches[0].clientX : e.clientX) - rect.left;
        const y = (e.touches ? e.touches[0].clientY : e.clientY) - rect.top;
        ctx.globalCompositeOperation = 'destination-out';

        const radius = canvas.width * 0.05;
        ctx.beginPath();
        ctx.arc(x, y, radius, 0, Math.PI * 2);
        ctx.fill();

        // åˆ¤æ–·è™Ÿç¢¼å€åŸŸæ˜¯å¦å·²ç¶“å®Œå…¨åˆ®é–‹
        const hiddenRect = span.getBoundingClientRect();
        const hiddenPixels = ctx.getImageData(
          hiddenRect.left - rect.left,
          hiddenRect.top - rect.top,
          hiddenRect.width,
          hiddenRect.height
        ).data;

        let transparent = 0;
        for (let i = 3; i < hiddenPixels.length; i += 4) {
          if (hiddenPixels[i] === 0) transparent++;
        }
        const ratio = transparent / (hiddenPixels.length / 4);

        // å¦‚æœè™Ÿç¢¼å€åŸŸé€æ˜æ¯”ä¾‹è¶…é 90%ï¼Œè¦–ç‚ºå®Œå…¨åˆ®å‡º
        if (ratio > 0.9 && !cell.dataset.revealed) {
          cell.dataset.revealed = "true";

          setTimeout(() => {
            cell.classList.remove('enlarged');
            cell.classList.add('revealed');
            if (cell.dataset.win === "true" && !cell.dataset.alerted) {
              alert('ğŸ‰ æ­å–œä¸­çï¼ä½ åˆ®åˆ°äº†è™Ÿç¢¼ ' + number);
              cell.dataset.alerted = "true";
              cell.classList.add('win');
            }
            enablePageScroll();
          }, 1500); // å»¶é² 1.5 ç§’ç¸®å°
        }
      }

      canvas.addEventListener('touchstart', (e) => { if (e.cancelable) e.preventDefault(); }, { passive: false });
      canvas.addEventListener('touchmove', scratch, { passive: false });
      canvas.addEventListener('mousemove', scratch);
    }

    function createScratchCell(cell, number, isWin, alreadyRevealed) {
      if (!alreadyRevealed) {
        // å»ºç«‹é€æ˜ä½”ä½æ ¼å­
        const placeholder = document.createElement('div');
        placeholder.className = 'cell placeholder';
        cell.parentNode.insertBefore(placeholder, cell);

        // å…ˆæ²åˆ°ä¸­é–“ï¼Œç¢ºä¿ iPhone Safari èƒ½å®šä½
        cell.scrollIntoView({
          behavior: 'smooth',
          block: 'center',
          inline: 'center'
        });
        // å†å¥—ç”¨æ”¾å¤§æ¨£å¼
        setTimeout(() => {
          cell.classList.add('enlarged');
          disablePageScroll();
        }, 300);

        // ç•¶ç¸®å°æ™‚ç§»é™¤ä½”ä½æ ¼å­
        cell.addEventListener('transitionend', () => {
          if (!cell.classList.contains('enlarged') && placeholder.parentNode) {
            placeholder.remove();
          }
        });
      }
      initScratchCanvas(cell, number);
      if (isWin) cell.dataset.win = "true";
      if (alreadyRevealed) {
        cell.classList.add('revealed');
        cell.dataset.revealed = "true";
        if (isWin) cell.classList.add('win');
      }
    }
  </script>
</body>
</html>