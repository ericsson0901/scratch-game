<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>刮刮樂遊戲</title>
  <link rel="stylesheet" href="style.css">
  <style>
    /* 廣告遮罩樣式 */
    #adOverlay {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.85);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      color: #fff;
      text-align: center;
    }
    #adOverlay img {
      max-width: 80%;
      border-radius: 10px;
      margin-bottom: 20px;
      box-shadow: 0 0 20px rgba(255,255,255,0.5);
    }
    #closeAdBtn {
      padding: 10px 20px;
      font-size: 18px;
      background: #4caf50;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      color: #fff;
    }
    .grid {
      display: grid;
      gap: 5px;
      margin-top: 20px;
    }
    .cell {
      width: 60px;
      height: 60px;
      background: #ccc;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 20px;
      cursor: pointer;
      border-radius: 5px;
      position: relative;
      overflow: hidden;
      transition: transform 0.2s ease;
    }
    /* 放大時像手機全螢幕一樣，並置中 */
    .cell.enlarged {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(1);
      width: 80vw;
      height: 80vw;
      background: #fff;
      z-index: 1000;
    }
    /* 刮完保持白底 */
    .cell.revealed {
      background: #fff;
    }
    .scratchCanvas {
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      /* 阻止 iPhone Safari 將觸控解讀成捲動 */
      touch-action: none;
    }
    .hiddenNumber {
      position: absolute;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      font-size: 20px;
      color: #000;
      pointer-events: none;
      transition: font-size 0.2s ease;
    }
    /* 放大時字體按比例放大 */
    .cell.enlarged .hiddenNumber {
      font-size: 20vw;
    }
    /* 中獎而且已經刮完縮小後才變金色 */
    .cell.win.revealed .hiddenNumber {
      color: gold;
      font-weight: bold;
    }
    /* 遊戲代碼清單樣式 */
    #gameListUl {
      list-style: none;
      padding: 0;
    }
    #gameListUl li {
      margin: 10px 0;
    }
    #gameListUl button {
      padding: 8px 16px;
      font-size: 16px;
      background: #4caf50;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      color: #fff;
    }
    #gameListUl button:hover {
      background: #45a049;
    }

    body.noscroll {
      overflow: hidden;
      width: 100%;
    }
  </style>
</head>
<body>
  <!-- 廣告遮罩 -->
  <div id="adOverlay">
    <img src="https://copilot.microsoft.com/th/id/BCO.43bb37ac-c81c-4745-bd9c-b3572581f76e.png" alt="系統家具設計廣告">
    <button id="closeAdBtn">聯絡我們</button>
  </div>

  <!-- 登入區塊 -->
  <div id="login" style="display:none;">
    <h2>請輸入電話號碼</h2>
    <input type="password" id="password" placeholder="輸入電話號碼">
    <button id="loginBtn">登入</button>
  </div>

  <!-- 選擇遊戲代碼區塊 -->
  <div id="selectGame" style="display:none;">
    <h2>選擇遊戲代碼</h2>
    <button id="refreshGameListBtn">更新清單</button>
    <ul id="gameListUl"></ul>
  </div>

  <!-- 遊戲區塊 -->
  <div id="game" style="display:none;">
    <h2>中獎號碼：<span id="winning"></span></h2>
    <p>已刮出：<span id="scratchedCount">0</span>　剩下：<span id="remainingCount">0</span></p>
    <div class="grid" id="grid"></div>
  </div>

  <script src="game.js"></script>
  <script>
    // 全域禁止捲動控制
    function disablePageScroll() {
      document.body.classList.add('noscroll');
      window._preventScroll = (e) => { if (e.cancelable) e.preventDefault(); };
      window.addEventListener('touchmove', window._preventScroll, { passive: false });
    }
    function enablePageScroll() {
      document.body.classList.remove('noscroll');
      if (window._preventScroll) {
        window.removeEventListener('touchmove', window._preventScroll);
        window._preventScroll = null;
      }
    }

    // 點擊廣告後顯示登入區塊
    document.getElementById('closeAdBtn').addEventListener('click', () => {
      document.getElementById('adOverlay').style.display = 'none';
      document.getElementById('login').style.display = 'block';
    });

    // 登入驗證全域密碼
    document.getElementById('loginBtn').addEventListener('click', async () => {
      const password = document.getElementById('password').value;
      const res = await fetch('/api/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ password })
      });
      if (res.ok) {
        document.getElementById('login').style.display = 'none';
        document.getElementById('selectGame').style.display = 'block';
        loadGameList();
      } else {
        const err = await res.json();
        alert(err.error || '密碼錯誤');
      }
    });

    // 載入遊戲代碼清單
    async function loadGameList() {
      const res = await fetch('/api/game-list');
      if (res.ok) {
        const data = await res.json();
        const ul = document.getElementById('gameListUl');
        ul.innerHTML = '';
        data.codes.forEach(code => {
          const li = document.createElement('li');
          const btn = document.createElement('button');
          btn.textContent = code;
          btn.onclick = () => startSelectedGame(code);
          li.appendChild(btn);
          ul.appendChild(li);
        });
      } else {
        alert('無法取得遊戲清單');
      }
    }

    document.getElementById('refreshGameListBtn').addEventListener('click', loadGameList);

    async function startSelectedGame(gameCode) {
      try {
        const res = await fetch(`/api/game/state?code=${gameCode}&playerId=${Date.now()}`);
        if (res.ok) {
          document.getElementById('selectGame').style.display = 'none';
          document.getElementById('game').style.display = 'block';
          const data = await res.json();
          if (typeof startGame === 'function') {
            startGame(gameCode, data);
          }
        } else {
          const err = await res.json();
          if (err.error && err.error.includes('locked')) {
            alert('其他玩家正在進行遊戲，請稍後再試');
          } else {
            alert(err.error || '無法進入遊戲');
          }
        }
      } catch (e) {
        alert('連線錯誤，請稍後再試');
      }
    }

    function showWinningNumbers(numbers) {
      document.getElementById('winning').textContent = numbers.join(', ');
    }
  <!-- 廣告遮罩 -->
  <div id="adOverlay">
    <img src="https://copilot.microsoft.com/th/id/BCO.43bb37ac-c81c-4745-bd9c-b3572581f76e.png" alt="系統家具設計廣告">
    <button id="closeAdBtn">聯絡我們</button>
  </div>

  <!-- 登入區塊 -->
  <div id="login" style="display:none;">
    <h2>請輸入電話號碼</h2>
    <input type="password" id="password" placeholder="輸入電話號碼">
    <button id="loginBtn">登入</button>
  </div>

  <!-- 選擇遊戲代碼區塊 -->
  <div id="selectGame" style="display:none;">
    <h2>選擇遊戲代碼</h2>
    <button id="refreshGameListBtn">更新清單</button>
    <ul id="gameListUl"></ul>
  </div>

  <!-- 遊戲區塊 -->
  <div id="game" style="display:none;">
    <h2>中獎號碼：<span id="winning"></span></h2>
    <p>已刮出：<span id="scratchedCount">0</span>　剩下：<span id="remainingCount">0</span></p>
    <div class="grid" id="grid"></div>
  </div>

  <script src="game.js"></script>
  <script>
    // 全域禁止捲動控制
    function disablePageScroll() {
      document.body.classList.add('noscroll');
      window._preventScroll = (e) => { if (e.cancelable) e.preventDefault(); };
      window.addEventListener('touchmove', window._preventScroll, { passive: false });
    }
    function enablePageScroll() {
      document.body.classList.remove('noscroll');
      if (window._preventScroll) {
        window.removeEventListener('touchmove', window._preventScroll);
        window._preventScroll = null;
      }
    }

    // 點擊廣告後顯示登入區塊
    document.getElementById('closeAdBtn').addEventListener('click', () => {
      document.getElementById('adOverlay').style.display = 'none';
      document.getElementById('login').style.display = 'block';
    });

    // 登入驗證全域密碼
    document.getElementById('loginBtn').addEventListener('click', async () => {
      const password = document.getElementById('password').value;
      const res = await fetch('/api/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ password })
      });
      if (res.ok) {
        document.getElementById('login').style.display = 'none';
        document.getElementById('selectGame').style.display = 'block';
        loadGameList();
      } else {
        const err = await res.json();
        alert(err.error || '密碼錯誤');
      }
    });

    // 載入遊戲代碼清單
    async function loadGameList() {
      const res = await fetch('/api/game-list');
      if (res.ok) {
        const data = await res.json();
        const ul = document.getElementById('gameListUl');
        ul.innerHTML = '';
        data.codes.forEach(code => {
          const li = document.createElement('li');
          const btn = document.createElement('button');
          btn.textContent = code;
          btn.onclick = () => startSelectedGame(code);
          li.appendChild(btn);
          ul.appendChild(li);
        });
      } else {
        alert('無法取得遊戲清單');
      }
    }

    document.getElementById('refreshGameListBtn').addEventListener('click', loadGameList);

    async function startSelectedGame(gameCode) {
      try {
        const res = await fetch(`/api/game/state?code=${gameCode}&playerId=${Date.now()}`);
        if (res.ok) {
          document.getElementById('selectGame').style.display = 'none';
          document.getElementById('game').style.display = 'block';
          const data = await res.json();
          if (typeof startGame === 'function') {
            startGame(gameCode, data);
          }
        } else {
          const err = await res.json();
          if (err.error && err.error.includes('locked')) {
            alert('其他玩家正在進行遊戲，請稍後再試');
          } else {
            alert(err.error || '無法進入遊戲');
          }
        }
      } catch (e) {
        alert('連線錯誤，請稍後再試');
      }
    }

    function showWinningNumbers(numbers) {
      document.getElementById('winning').textContent = numbers.join(', ');
    }
