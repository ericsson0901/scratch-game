<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>åˆ®åˆ®æ¨‚éŠæˆ²</title>
  <link rel="stylesheet" href="style.css">
  <style>
    /* å»£å‘Šé®ç½©æ¨£å¼ */
    #adOverlay {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.85);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      color: #fff;
      text-align: center;
    }
    #adOverlay img {
      max-width: 80%;
      border-radius: 10px;
      margin-bottom: 20px;
      box-shadow: 0 0 20px rgba(255,255,255,0.5);
    }
    #closeAdBtn {
      padding: 10px 20px;
      font-size: 18px;
      background: #4caf50;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      color: #fff;
    }
    .grid {
      display: grid;
      gap: 5px;
      margin-top: 20px;
    }
    .cell {
      width: 60px;
      height: 60px;
      background: #ccc;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 20px;
      cursor: pointer;
      border-radius: 5px;
      position: relative;
      overflow: hidden;
      transition: transform 0.2s ease;
    }
    /* æ”¾å¤§æ™‚åƒæ‰‹æ©Ÿå…¨è¢å¹•ä¸€æ¨£ */
    .cell.enlarged {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(1);
      width: 80vw;
      height: 80vw;
      background: #fff;
      z-index: 1000;
    }
    /* åˆ®å®Œä¿æŒç™½åº• */
    .cell.revealed {
      background: #fff;
    }
    .scratchCanvas {
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      /* æ–°å¢ï¼šé˜»æ­¢ iPhone Safari å°‡è§¸æ§è§£è®€æˆæ²å‹• */
      touch-action: none;
    }
    .hiddenNumber {
      position: absolute;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      font-size: 20px;
      color: #000;
      pointer-events: none;
      transition: font-size 0.2s ease;
    }
    /* æ”¾å¤§æ™‚å­—é«”æŒ‰æ¯”ä¾‹æ”¾å¤§ */
    .cell.enlarged .hiddenNumber {
      font-size: 20vw;
    }
    /* ä¸­çè€Œä¸”å·²ç¶“åˆ®å®Œç¸®å°å¾Œæ‰è®Šé‡‘è‰² */
    .cell.win.revealed .hiddenNumber {
      color: gold;
      font-weight: bold;
    }
    /* éŠæˆ²ä»£ç¢¼æ¸…å–®æ¨£å¼ */
    #gameListUl {
      list-style: none;
      padding: 0;
    }
    #gameListUl li {
      margin: 10px 0;
    }
    #gameListUl button {
      padding: 8px 16px;
      font-size: 16px;
      background: #4caf50;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      color: #fff;
    }
    #gameListUl button:hover {
      background: #45a049;
    }

    /* ä¿®æ”¹ï¼šç§»é™¤ position: fixed é¿å… iPhone å®šä½éŒ¯äº‚ */
    body.noscroll {
      overflow: hidden;
      width: 100%;
    }
  </style>
</head>
<body>
  <!-- å»£å‘Šé®ç½© -->
  <div id="adOverlay">
    <img src="https://copilot.microsoft.com/th/id/BCO.43bb37ac-c81c-4745-bd9c-b3572581f76e.png" alt="ç³»çµ±å®¶å…·è¨­è¨ˆå»£å‘Š">
    <button id="closeAdBtn">è¯çµ¡æˆ‘å€‘</button>
  </div>

  <!-- ç™»å…¥å€å¡Š -->
  <div id="login" style="display:none;">
    <h2>è«‹è¼¸å…¥é›»è©±è™Ÿç¢¼</h2>
    <input type="password" id="password" placeholder="è¼¸å…¥é›»è©±è™Ÿç¢¼">
    <button id="loginBtn">ç™»å…¥</button>
  </div>

  <!-- é¸æ“‡éŠæˆ²ä»£ç¢¼å€å¡Š -->
  <div id="selectGame" style="display:none;">
    <h2>é¸æ“‡éŠæˆ²ä»£ç¢¼</h2>
    <button id="refreshGameListBtn">æ›´æ–°æ¸…å–®</button>
    <ul id="gameListUl"></ul>
  </div>

  <!-- éŠæˆ²å€å¡Š -->
  <div id="game" style="display:none;">
    <h2>ä¸­çè™Ÿç¢¼ï¼š<span id="winning"></span></h2>
    <p>å·²åˆ®å‡ºï¼š<span id="scratchedCount">0</span>ã€€å‰©ä¸‹ï¼š<span id="remainingCount">0</span></p>
    <div class="grid" id="grid"></div>
  </div>
  <script src="game.js"></script>
  <script>
    // å…¨åŸŸç¦æ­¢æ²å‹•æ§åˆ¶
    function disablePageScroll() {
      document.body.classList.add('noscroll');
      window._preventScroll = (e) => { if (e.cancelable) e.preventDefault(); };
      window.addEventListener('touchmove', window._preventScroll, { passive: false });
    }
    function enablePageScroll() {
      document.body.classList.remove('noscroll');
      if (window._preventScroll) {
        window.removeEventListener('touchmove', window._preventScroll);
        window._preventScroll = null;
      }
    }

    // é»æ“Šå»£å‘Šå¾Œé¡¯ç¤ºç™»å…¥å€å¡Š
    document.getElementById('closeAdBtn').addEventListener('click', () => {
      document.getElementById('adOverlay').style.display = 'none';
      document.getElementById('login').style.display = 'block';
    });

    // ç™»å…¥é©—è­‰å…¨åŸŸå¯†ç¢¼
    document.getElementById('loginBtn').addEventListener('click', async () => {
      const password = document.getElementById('password').value;
      const res = await fetch('/api/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ password })
      });
      if (res.ok) {
        document.getElementById('login').style.display = 'none';
        document.getElementById('selectGame').style.display = 'block';
        loadGameList();
      } else {
        const err = await res.json();
        alert(err.error || 'å¯†ç¢¼éŒ¯èª¤');
      }
    });

    // è¼‰å…¥éŠæˆ²ä»£ç¢¼æ¸…å–®
    async function loadGameList() {
      const res = await fetch('/api/game-list');
      if (res.ok) {
        const data = await res.json();
        const ul = document.getElementById('gameListUl');
        ul.innerHTML = '';
        data.codes.forEach(code => {
          const li = document.createElement('li');
          const btn = document.createElement('button');
          btn.textContent = code;
          btn.onclick = () => startSelectedGame(code);
          li.appendChild(btn);
          ul.appendChild(li);
        });
      } else {
        alert('ç„¡æ³•å–å¾—éŠæˆ²æ¸…å–®');
      }
    }

    document.getElementById('refreshGameListBtn').addEventListener('click', loadGameList);

    async function startSelectedGame(gameCode) {
      try {
        const res = await fetch(`/api/game/state?code=${gameCode}&playerId=${Date.now()}`);
        if (res.ok) {
          document.getElementById('selectGame').style.display = 'none';
          document.getElementById('game').style.display = 'block';
          const data = await res.json();
          if (typeof startGame === 'function') {
            startGame(gameCode, data);
          }
        } else {
          const err = await res.json();
          if (err.error && err.error.includes('locked')) {
            alert('å…¶ä»–ç©å®¶æ­£åœ¨é€²è¡ŒéŠæˆ²ï¼Œè«‹ç¨å¾Œå†è©¦');
          } else {
            alert(err.error || 'ç„¡æ³•é€²å…¥éŠæˆ²');
          }
        }
      } catch (e) {
        alert('é€£ç·šéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦');
      }
    }

    function showWinningNumbers(numbers) {
      document.getElementById('winning').textContent = numbers.join(', ');
    }
    // åˆ®åˆ®æ¨‚æ•ˆæœåˆå§‹åŒ–
    function initScratchCanvas(cell, number) {
      const canvas = document.createElement('canvas');
      canvas.className = 'scratchCanvas';
      canvas.width = cell.offsetWidth;
      canvas.height = cell.offsetHeight;
      const ctx = canvas.getContext('2d');
      ctx.fillStyle = '#C0C0C0';
      ctx.fillRect(0, 0, canvas.width, canvas.height);

      const span = document.createElement('span');
      span.className = 'hiddenNumber';
      span.textContent = number;

      cell.appendChild(span);
      cell.appendChild(canvas);

      function resetCellStyle() {
        cell.style.position = '';
        cell.style.top = '';
        cell.style.left = '';
        cell.style.width = '';
        cell.style.height = '';
        cell.style.transform = '';
        cell.style.zIndex = '';
        enablePageScroll(); // é›¢é–‹æ”¾å¤§æ…‹æ™‚æ¢å¾©æ²å‹•
      }

      // é€²å…¥æ”¾å¤§æ…‹æ™‚é–ä½é é¢æ²å‹•
      if (cell.classList.contains('enlarged')) {
        disablePageScroll();
      }

      function scratch(e) {
        if (e.cancelable) e.preventDefault(); // é˜»æ­¢ iOS é è¨­æ²å‹•
        const rect = canvas.getBoundingClientRect();
        const x = (e.touches ? e.touches[0].clientX : e.clientX) - rect.left;
        const y = (e.touches ? e.touches[0].clientY : e.clientY) - rect.top;
        ctx.globalCompositeOperation = 'destination-out';

        const radius = canvas.width * 0.05;
        ctx.beginPath();
        ctx.arc(x, y, radius, 0, Math.PI * 2);
        ctx.fill();

        const pixels = ctx.getImageData(0, 0, canvas.width, canvas.height).data;
        let transparent = 0;
        for (let i = 3; i < pixels.length; i += 4) {
          if (pixels[i] === 0) transparent++;
        }
        const ratio = transparent / (canvas.width * canvas.height);

        if (ratio > 0.4 && !cell.dataset.revealed) {
          cell.classList.remove('enlarged');
          resetCellStyle();
          cell.classList.add('revealed');
          cell.dataset.revealed = "true";

          if (cell.dataset.win === "true" && !cell.dataset.alerted) {
            alert('ğŸ‰ æ­å–œä¸­çï¼ä½ åˆ®åˆ°äº†è™Ÿç¢¼ ' + number);
            cell.dataset.alerted = "true";
            cell.classList.add('win');
          }
        }
      }

      canvas.addEventListener('touchstart', (e) => { if (e.cancelable) e.preventDefault(); }, { passive: false });
      canvas.addEventListener('touchmove', scratch, { passive: false });
      canvas.addEventListener('mousemove', scratch);

      // ä¸€åˆ†é˜å¾Œè‡ªå‹•ç¸®å°
      setTimeout(() => {
        if (!cell.dataset.revealed && cell.classList.contains('enlarged')) {
          cell.classList.remove('enlarged');
          resetCellStyle();
          if (cell.dataset.win === "true") {
            cell.classList.add('revealed');
            cell.classList.add('win');
          }
        }
      }, 60000);
    }

    function createScratchCell(cell, number, isWin, alreadyRevealed) {
      if (!alreadyRevealed) {
        cell.classList.add('enlarged');
      }
      initScratchCanvas(cell, number);
      if (isWin) cell.dataset.win = "true";
      if (alreadyRevealed) {
        cell.classList.add('revealed');
        cell.dataset.revealed = "true";
        if (isWin) cell.classList.add('win');
      }
    }
  </script>
</body>
</html>