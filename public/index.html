<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>åˆ®åˆ®æ¨‚éŠæˆ²</title>
  <!-- æ–°å¢ï¼šviewportï¼Œå¯ç”± JS å‹•æ…‹ä¿®æ”¹ -->
  <meta id="viewportMeta" name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="style.css">
  <style>
    /* å»£å‘Šé®ç½©æ¨£å¼ */
    #adOverlay {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.85);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      color: #fff;
      text-align: center;
    }
    #adOverlay img {
      max-width: 80%;
      border-radius: 10px;
      margin-bottom: 20px;
      box-shadow: 0 0 20px rgba(255,255,255,0.5);
    }
    #closeAdBtn {
      padding: 10px 20px;
      font-size: 18px;
      background: #4caf50;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      color: #fff;
    }
    .grid {
      display: grid;
      gap: 5px;
      margin-top: 20px;
    }
    .cell {
      width: 60px;
      height: 60px;
      background: #ccc;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 20px;
      cursor: pointer;
      border-radius: 5px;
      position: relative;
      overflow: hidden;
      transition: transform 0.2s ease;
    }
    .cell.enlarged {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(1);
      width: 80vw;
      height: 80vw;
      background: #fff;
      z-index: 1000;
    }
    .placeholder {
      width: 60px;
      height: 60px;
      visibility: hidden;
    }
    .cell.revealed {
      background: #fff;
    }
    .scratchCanvas {
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      touch-action: none;
    }
    .hiddenNumber {
      position: absolute;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      font-size: 20px;
      color: #000;
      pointer-events: none;
      transition: font-size 0.2s ease;
    }
    .cell.enlarged .hiddenNumber {
      font-size: 20vw;
    }
    .cell.win.revealed .hiddenNumber {
      color: gold;
      font-weight: bold;
    }
    #gameListUl {
      list-style: none;
      padding: 0;
    }
    #gameListUl li {
      margin: 10px 0;
    }
    #gameListUl button {
      padding: 8px 16px;
      font-size: 16px;
      background: #4caf50;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      color: #fff;
    }
    #gameListUl button:hover {
      background: #45a049;
    }
    body.noscroll {
      overflow: hidden;
      width: 100%;
    }
    body.zoomedOut {
      transform: scale(0.85);
      transform-origin: top center;
    }
  </style>
</head>
<body>
  <!-- å»£å‘Šé®ç½© -->
  <div id="adOverlay">
    <img src="https://copilot.microsoft.com/th/id/BCO.43bb37ac-c81c-4745-bd9c-b3572581f76e.png" alt="ç³»çµ±å®¶å…·è¨­è¨ˆå»£å‘Š">
    <!-- ä¿®æ”¹ï¼šæŒ‰éˆ•æ”¹æˆè·³è½‰åˆ°è¯çµ¡é é¢ -->
    <button id="closeAdBtn" onclick="window.location.href='/contact.html'">è¯çµ¡æˆ‘å€‘</button>
  </div>

  <!-- ç™»å…¥å€å¡Š -->
  <div id="login" style="display:none;">
    <h2>è«‹è¼¸å…¥é›»è©±è™Ÿç¢¼</h2>
    <input type="password" id="password" placeholder="è¼¸å…¥é›»è©±è™Ÿç¢¼">
    <button id="loginBtn">ç™»å…¥</button>
  </div>
  <!-- é¸æ“‡éŠæˆ²ä»£ç¢¼å€å¡Š -->
  <div id="selectGame" style="display:none;">
    <h2>é¸æ“‡éŠæˆ²ä»£ç¢¼</h2>
    <button id="refreshGameListBtn">æ›´æ–°æ¸…å–®</button>
    <ul id="gameListUl"></ul>
  </div>

  <!-- éŠæˆ²å€å¡Š -->
  <div id="game" style="display:none;">
    <h2>ä¸­çè™Ÿç¢¼ï¼š<span id="winning"></span></h2>
    <p>å·²åˆ®å‡ºï¼š<span id="scratchedCount">0</span>ã€€å‰©ä¸‹ï¼š<span id="remainingCount">0</span></p>
    <div class="grid" id="grid"></div>
  </div>
  <script src="game.js"></script>
  <script>
    // å¿ƒè·³æ©Ÿåˆ¶ï¼šå®šæœŸå‘¼å«å¾Œç«¯ API
    let heartbeatInterval = null;
    let currentGameCode = null;

    async function sendHeartbeat() {
      if (!currentGameCode) return;
      try {
        const res = await fetch(`/api/game/${currentGameCode}/heartbeat`, {
          method: 'POST'
        });
        if (res.ok) {
          const data = await res.json();
          console.log(`Heartbeat sent, lockedUntil=${data.lockedUntil}`);
        }
      } catch (err) {
        console.error('Heartbeat error:', err);
      }
    }

    function startHeartbeat(gameCode) {
      currentGameCode = gameCode;
      if (heartbeatInterval) clearInterval(heartbeatInterval);
      // æ¯ 30 ç§’é€ä¸€æ¬¡å¿ƒè·³
      heartbeatInterval = setInterval(sendHeartbeat, 30 * 1000);
      // ç«‹å³é€ä¸€æ¬¡å¿ƒè·³
      sendHeartbeat();
    }

    function stopHeartbeat() {
      if (heartbeatInterval) {
        clearInterval(heartbeatInterval);
        heartbeatInterval = null;
      }
      currentGameCode = null;
    }
    function startSelectedGame(gameCode) {
      document.getElementById('selectGame').style.display = 'none';
      document.getElementById('game').style.display = 'block';
      if (typeof startGame === 'function') {
        startGame(gameCode);
      }
      // å•Ÿå‹•å¿ƒè·³æ©Ÿåˆ¶
      startHeartbeat(gameCode);
    }

    function showWinningNumbers(numbers) {
      document.getElementById('winning').textContent = numbers.join(', ');
    }

    // å…¨åŸŸè®Šæ•¸ï¼šç›®å‰æ”¾å¤§çš„æ ¼å­ & æ˜¯å¦æœ‰æ ¼å­æ”¾å¤§
    let currentEnlargedCell = null;
    let isAnyCellEnlarged = false;

    // åˆ®åˆ®æ¨‚æ•ˆæœåˆå§‹åŒ–
    function initScratchCanvas(cell, number) {
      const canvas = document.createElement('canvas');
      canvas.className = 'scratchCanvas';
      canvas.width = cell.offsetWidth;
      canvas.height = cell.offsetHeight;
      const ctx = canvas.getContext('2d');
      ctx.fillStyle = '#C0C0C0';
      ctx.fillRect(0, 0, canvas.width, canvas.height);

      const span = document.createElement('span');
      span.className = 'hiddenNumber';
      span.textContent = number;

      cell.appendChild(span);
      cell.appendChild(canvas);

      function resetCellStyle() {
        if (cell._placeholder) {
          cell._placeholder.remove();
          cell._placeholder = null;
        }
        cell.classList.remove('enlarged');
        cell.style.position = '';
        cell.style.top = '';
        cell.style.left = '';
        cell.style.width = '';
        cell.style.height = '';
        cell.style.transform = '';
        cell.style.zIndex = '';
        document.body.classList.remove('zoomedOut');
        unlockViewport();
        enablePageScroll();
        currentEnlargedCell = null; 
        isAnyCellEnlarged = false;

        document.querySelectorAll('.cell').forEach(c => {
          c.style.pointerEvents = '';
        });
      }

      let scratched = false;

      function scratch(e) {
        if (e.cancelable) e.preventDefault();
        scratched = true;

        const rect = canvas.getBoundingClientRect();
        const x = (e.touches ? e.touches[0].clientX : e.clientX) - rect.left;
        const y = (e.touches ? e.touches[0].clientY : e.clientY) - rect.top;
        ctx.globalCompositeOperation = 'destination-out';

        const radius = canvas.width * 0.1;
        ctx.beginPath();
        ctx.arc(x, y, radius, 0, Math.PI * 2);
        ctx.fill();

        cell.dataset.scratched = "true";

        const numberRect = span.getBoundingClientRect();
        const canvasRect = canvas.getBoundingClientRect();
        const sx = numberRect.left - canvasRect.left;
        const sy = numberRect.top - canvasRect.top;
        const sw = numberRect.width;
        const sh = numberRect.height;

        const pixels = ctx.getImageData(sx, sy, sw, sh).data;
        let transparent = 0;
        for (let i = 3; i < pixels.length; i += 4) {
          if (pixels[i] === 0) transparent++;
        }
        const ratio = transparent / (sw * sh);

        if (ratio > 0.9 && !cell.dataset.revealed) {
          setTimeout(() => {
            cell.classList.remove('enlarged');
            resetCellStyle();
            cell.classList.add('revealed');
            cell.dataset.revealed = "true";

            cell.scrollIntoView({ behavior: 'smooth', block: 'center', inline: 'center' });

            if (cell.dataset.win === "true" && !cell.dataset.alerted) {
              alert('ğŸ‰ æ­å–œä¸­çï¼ä½ åˆ®åˆ°äº†è™Ÿç¢¼ ' + number);
              cell.dataset.alerted = "true";
              cell.classList.add('win');
            }
          }, 1500);
        }
      }

      canvas.addEventListener('touchstart', (e) => { if (e.cancelable) e.preventDefault(); }, { passive: false });
      canvas.addEventListener('touchmove', scratch, { passive: false });
      canvas.addEventListener('mousemove', scratch);
    }

    function createScratchCell(cell, number, isWin, alreadyRevealed) {
      if (isAnyCellEnlarged && !cell.classList.contains('enlarged')) {
        return;
      }

      if (!alreadyRevealed) {
        const placeholder = document.createElement('div');
        placeholder.className = 'placeholder';
        cell.parentNode.insertBefore(placeholder, cell);

        cell.scrollIntoView({ behavior: 'smooth', block: 'center', inline: 'center' });
        setTimeout(() => {
          cell.classList.add('enlarged');
          disablePageScroll();
          lockViewport();
          currentEnlargedCell = cell;
          isAnyCellEnlarged = true;

          document.querySelectorAll('.cell').forEach(c => {
            if (c !== cell) {
              c.style.pointerEvents = 'none';
            }
          });
        }, 500);

        cell._placeholder = placeholder;
      }

      initScratchCanvas(cell, number);
      if (isWin) cell.dataset.win = "true";
      if (alreadyRevealed) {
        cell.classList.add('revealed');
        cell.dataset.revealed = "true";
        if (isWin) cell.classList.add('win');
      }
    }

    // ç•¶ç©å®¶é›¢é–‹é é¢æ™‚åœæ­¢å¿ƒè·³
    window.addEventListener('beforeunload', stopHeartbeat);
  </script>
</body>
</html>